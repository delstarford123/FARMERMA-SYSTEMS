{% extends "base.html" %}

{% block content %}
<div class="container-fluid bg-light min-vh-100 py-5 overflow-hidden">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4 access-header">
            <div>
                <h2 class="fw-bold text-dark decode-access"><i class="bi bi-shield-lock me-2 text-success"></i>Access Control</h2>
                <p class="text-muted">Manage global user permissions, billing tiers, and corporate account roles.</p>
            </div>
            <div class="header-btns">
                <button class="btn btn-success shadow-sm magnetic-btn" onclick="window.print()">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Export Audit Log
                </button>
            </div>
        </div>

        <div class="row g-4 mb-4 text-center stats-row">
            <div class="col-md-4 stat-card">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase small fw-bold">Global Accounts</h6>
                        <h3 class="fw-bold mb-0">{{ subscribers|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 stat-card">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase small fw-bold">Active Subscriptions</h6>
                        <h3 class="fw-bold mb-0 text-success">
                            {{ subscribers|selectattr('subscription_tier', 'equalto', 'pro')|list|length }}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 stat-card">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase small fw-bold">Processing Payments</h6>
                        <h3 class="fw-bold mb-0 text-warning">
                            {{ subscribers|selectattr('subscription_status', 'equalto', 'pending_payment')|list|length }}
                        </h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm management-table-card">
            <div class="card-header bg-white py-3">
                <div class="input-group" style="max-width: 400px;">
                    <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="subscriberSearch" class="form-control bg-light border-0" placeholder="Filter by name, UID, or organization...">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-muted">
                            <tr>
                                <th class="ps-4">User Details</th>
                                <th>Corporate/Org</th>
                                <th>Account Tier</th>
                                <th>Access Level</th>
                                <th class="text-end pe-4">Management</th>
                            </tr>
                        </thead>
                        <tbody id="subscriberTableBody">
                            {% for sub in subscribers %}
                            <tr class="sub-row">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-dark text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            {{ sub.full_name[0] | upper if sub.full_name else 'U' }}
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ sub.full_name }}</div>
                                            <div class="small text-muted">{{ sub.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="text-dark fw-medium">{{ sub.organization or 'Independent' }}</span>
                                    <div class="small text-muted">UID: {{ sub.uid[:8] }}...</div>
                                </td>
                                <td>
                                    {% if sub.subscription_tier == 'pro' %}
                                        <span class="badge rounded-pill bg-success-subtle text-success border border-success px-3">PRO</span>
                                    {% else %}
                                        <span class="badge rounded-pill bg-secondary-subtle text-secondary border px-3">FREE</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="form-select form-select-sm border-0 bg-light w-auto fw-bold" onchange="updateRole('{{ sub.uid }}', this.value)">
                                        <option value="client" {% if sub.role == 'client' %}selected{% endif %}>Client</option>
                                        <option value="admin" {% if sub.role == 'admin' %}selected{% endif %}>Admin</option>
                                        <option value="researcher" {% if sub.role == 'researcher' %}selected{% endif %}>Researcher</option>
                                    </select>
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="alert('Accessing detailed logs for {{ sub.uid }}')"><i class="bi bi-activity"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirm('Are you sure you want to revoke access for this account?')"><i class="bi bi-slash-circle"></i></button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <i class="bi bi-cloud-slash text-muted display-4"></i>
                                    <p class="mt-2 text-muted">No global accounts found in Firebase records.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Prevent pre-animation flash */
    .access-header, .stat-card, .management-table-card, .sub-row { opacity: 0; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>

<script>
    gsap.registerPlugin(TextPlugin);

    // 1. Decoded Effect for Header
    gsap.from(".decode-access", {
        text: { value: "▓▒░█▓▒░█▓▒░█▓▒", chars: "XO!#" },
        duration: 1.5,
        ease: "none",
        onStart: () => gsap.set(".access-header", {opacity: 1})
    });

    // 2. Elastic Snap for Stats Cards
    gsap.to(".stat-card", {
        y: 0,
        opacity: 1,
        startAt: { y: -100 },
        stagger: 0.2,
        duration: 1.5,
        ease: "elastic.out(1, 0.3)",
        delay: 0.5
    });

    // 3. Perspective Fly for Management Table
    gsap.to(".management-table-card", {
        z: 0,
        opacity: 1,
        startAt: { z: -1000 },
        transformPerspective: 1000,
        duration: 1.2,
        ease: "power3.out",
        delay: 0.8
    });

    // 4. Cascade Reveal for Subscriber Rows
    gsap.to(".sub-row", {
        x: 0,
        opacity: 1,
        startAt: { x: -30 },
        stagger: 0.05,
        duration: 0.5,
        ease: "power2.out",
        delay: 1.2
    });

    // 5. Magnetic Pull for Export Button
    const exportBtn = document.querySelector(".magnetic-btn");
    exportBtn.addEventListener("mousemove", (e) => {
        const rect = exportBtn.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        gsap.to(exportBtn, { x: x * 0.3, y: y * 0.3, duration: 0.3 });
    });
    exportBtn.addEventListener("mouseleave", () => {
        gsap.to(exportBtn, { x: 0, y: 0, duration: 0.3 });
    });

    // UI Search Logic
    document.getElementById('subscriberSearch').addEventListener('keyup', function() {
        let value = this.value.toLowerCase();
        let rows = document.querySelectorAll('#subscriberTableBody tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none';
        });
    });

    // Role Sync Logic
    function updateRole(uid, newRole) {
        if(!confirm(`Change access level to ${newRole.toUpperCase()}?`)) return;
        fetch('/admin/update-role', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: uid, role: newRole })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) console.log("Firebase Role Updated");
            else alert(`System Error: ${data.error}`);
        });
    }
</script>
{% endblock %}