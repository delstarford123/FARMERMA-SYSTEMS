{% extends "base.html" %}

{% block content %}
<script src="https://js.paystack.co/v1/inline.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD"></script>

<div class="container py-5 overflow-hidden">
    <div class="row justify-content-center text-center mb-5">
        <div class="col-md-8">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <h2 class="fw-bold mb-3 checkout-title" style="color: #5D4037;">Activate {{ plan_name }}</h2>
            <p class="text-muted checkout-lead">Select your preferred payment gateway to securely activate your account.</p>
        </div>
    </div>

    <div class="row justify-content-center g-4">
        
        <div class="col-md-6 col-lg-3 payment-card">
            <div class="card h-100 shadow-lg border-0 border-top border-4" style="border-color: #2E7D32 !important;">
                <div class="card-body p-4 text-center d-flex flex-column">
                    <h4 class="fw-bold mb-3">M-Pesa</h4>
                    <p class="text-muted small mb-4">Instant mobile payment (KES {{ amount_kes }})</p>
                    
                    <form action="{{ url_for('process_mpesa') }}" method="POST" class="mt-auto mpesa-form">
                        <div class="mb-3 text-start">
                            <label class="form-label small fw-bold" style="color: #5D4037;">Phone Number</label>
                            <input type="text" name="phone_number" class="form-control bg-light shadow-sm" placeholder="2547XXXXXXXX" required>
                            
                            <input type="hidden" name="amount" value="{{ amount_kes }}">
                            <input type="hidden" name="plan_id" value="{{ plan_id }}">
                        </div>
                        <button type="submit" class="btn w-100 fw-bold magnetic-btn text-white" style="background-color: #2E7D32;">
                            <i class="bi bi-phone me-2"></i>Pay M-Pesa
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 payment-card">
            <div class="card h-100 shadow-lg border-0 border-top border-4" style="border-color: #0288D1 !important;">
                <div class="card-body p-4 text-center d-flex flex-column">
                    <h4 class="fw-bold mb-3">Local Card</h4>
                    <p class="text-muted small mb-4">Visa/Mastercard via Paystack (KES {{ amount_kes }})</p>
                    
                    <button id="paystack-button" class="btn btn-outline-primary mt-auto w-100 fw-bold magnetic-btn" style="color: #0288D1; border-color: #0288D1;">
                        <i class="bi bi-credit-card me-2"></i>Pay via Paystack
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 payment-card">
            <div class="card h-100 shadow-lg border-0 border-top border-4" style="border-color: #6772E5 !important;">
                <div class="card-body p-4 text-center d-flex flex-column">
                    <h4 class="fw-bold mb-3">Global Card</h4>
                    <p class="text-muted small mb-4">International Cards via Stripe (${{ amount_usd }})</p>
                    
                    <button id="stripe-button" class="btn btn-outline-primary mt-auto w-100 fw-bold magnetic-btn" style="color: #6772E5; border-color: #6772E5;">
                        <i class="bi bi-globe me-2"></i>Pay via Stripe
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 payment-card">
            <div class="card h-100 shadow-lg border-0 border-top border-4" style="border-color: #FFC107 !important;">
                <div class="card-body p-4 text-center d-flex flex-column">
                    <h4 class="fw-bold mb-3">PayPal</h4>
                    <p class="text-muted small mb-4">Fast and safe checkout (${{ amount_usd }})</p>
                    
                    <div id="paypal-button-container" class="mt-auto w-100 z-1"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    .payment-card { opacity: 0; }
    .btn-outline-primary:hover { color: white !important; }
    #stripe-button:hover { background-color: #6772E5; border-color: #6772E5; }
    #paystack-button:hover { background-color: #0288D1; border-color: #0288D1; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
    gsap.to(".payment-card", { y: 0, opacity: 1, startAt: { y: 40 }, stagger: 0.15, duration: 0.8, ease: "power3.out" });

    // 2. PAYSTACK LOGIC
    document.getElementById('paystack-button').addEventListener('click', function(e) {
        e.preventDefault();
        let handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}', 
            email: '{{ session.get("email", "user@farmerman.com") }}', 
            amount: {{ amount_kes }} * 100, 
            currency: 'KES', 
            ref: 'FMS_' + '{{ plan_id }}' + '_' + Math.floor((Math.random() * 1000000000) + 1), 
            callback: function(response) {
                window.location.href = "/verify-paystack?reference=" + response.reference + "&plan={{ plan_id }}";
            },
            onClose: function() { alert('Payment window closed.'); }
        });
        handler.openIframe();
    });

    // 3. STRIPE LOGIC
    var stripe = Stripe('{{ stripe_public_key }}');
    document.getElementById('stripe-button').addEventListener('click', function() {
        fetch('/create-stripe-session', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan: '{{ plan_id }}' }) 
        })
        .then(function(response) { return response.json(); })
        .then(function(session) { return stripe.redirectToCheckout({ sessionId: session.id }); })
        .catch(function(error) { console.error('Error:', error); });
    });

    // 4. PAYPAL LOGIC
    paypal.Buttons({
        style: { layout: 'horizontal', color: 'gold', shape: 'rect', label: 'paypal', height: 40 },
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{ amount: { value: '{{ amount_usd }}' } }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                fetch('/paypal-transaction-complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderID: data.orderID, plan: '{{ plan_id }}' })
                }).then(function() {
                    window.location.href = "{{ url_for('payment_success') }}";
                });
            });
        }
    }).render('#paypal-button-container');
</script>
{% endblock %}